{
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "botAppId": {
            "type": "string", 
            "metadata": {
                "description": "This is the Bot Framework Application ID"
            }
        }, 
        "botDisplayName": {
            "type":"string", 
            "metadata": {
                "description": "This is the name of your application"
            }
        }, 
        "botDescription": {
            "type":"string", 
            "metadata": {
                "description":"Give your application a description"
            }
        },
        "iconUrl": {
            "type":"string", 
            "metadata": {
                "description": "Please provide an icon that would resolve to a .PNG file"
            }
        },
        "repoUrl": {
            "type": "string", 
            "metadata": {
                "description": "Please provide a GitHub link for the deployment of the code"
            }
        }, 
        "branchName": {
            "type": "string", 
            "metadata": {
                "description": "Please provide the exact branch of the GitHub repository"
            }, 
            "defaultValue": "master"
        }, 
        "configUri": {
            "type":"string", 
            "metadata": {
                "description": "Provide a location for your asset definitions"
            }
        }
    },
    "variables": {
        "botName": "[concat('stickers-', uniqueString(resourceGroup().id))]",
        "stickerAppInsightsName": "appInsightStickers",
        "azfuncStorageAccountName":"[concat(uniqueString(resourceGroup().id), 'azfunctions')]",
        "stickersFunctionAppName": "[concat('stickersFnApp-', uniqueString(resourceGroup().id))]"
    },
    "resources": [
        {
            "name":"[variables('botName')]",
            "type": "Microsoft.BotService/botServices",
            "location": "global",
            "apiVersion": "2018-07-12",
            "tags": {},
            "sku": {
                "name": "F0"
            }, 
            "kind": "sdk", 
            "properties": {
                "displayName":"[parameters('botDisplayName')]",
                "description":"[parameters('botDescription')]",
                "endpoint": "[concat('https://', variables('botName'), '.azurewebsites.net/api/messages')]",
                "iconUrl": "[parameters('iconUrl')]",
                "msaAppId":"[parameters('botAppId')]", 
                "developerAppInsightKey": "[reference(resourceId('Microsoft.Insights/components', variables('stickerAppInsightsName')), '2015-05-01').InstrumentationKey]"
            },
            "resources": [
                {
                    "name": "[concat(variables('botName'), '/MsTeamsChannel')]", 
                    "type": "Microsoft.BotService/botServices/channels", 
                    "apiVersion": "2018-07-12",
                    "location": "global",
                    "tags": {}, 
                    "sku": {
                        "name":"F0"
                    }, 
                    "properties": {
                        "channelName":"MsTeamsChannel",
                        "location":"global", 
                        "properties": {
                            "isEnabled":true
                        }
                    }, 
                    "dependsOn": [
                        "[concat('Microsoft.BotService/botServices/', variables('botName'))]"
                    ]
                }
            ]
        }, 
        {
            "type": "Microsoft.Web/serverfarms", 
            "apiVersion": "2018-02-01", 
            "location":"[resourceGroup().location]", 
            "name": "stickerAzHostingPlan", 
            "sku": {
                "name":"S1", 
                "capacity": "0"
            }, 
            "properties": {
                "name": "stickerAzHostingPlan"
            }
        },
        {
            "type":"Microsoft.Storage/storageAccounts",
            "apiVersion": "2016-12-01", 
            "name": "[variables('azfuncStorageAccountName')]", 
            "location": "[resourceGroup().location]", 
            "kind": "Storage", 
            "sku": {
                "name": "Standard_LRS"
            }
        },
        {
            "type": "Microsoft.Web/sites", 
            "apiVersion": "2016-08-01", 
            "name": "[variables('stickersFunctionAppName')]", 
            "location": "[resourceGroup().location]", 
            "kind":"functionapp",
            "scale":null,  
            "dependsOn": [
                "[concat('Microsoft.Web/serverfarms/', 'stickerAzHostingPlan')]", 
                "[concat('Microsoft.Storage/storageAccounts/', variables('azfuncStorageAccountName'))]"
            ], 
            "properties": {
                "enabled":true,
                "hostNameSslStates": [
                    {
                        "name": "[concat(variables('botName'),'.azurewebsites.net')]",
                        "sslState": "Disabled",
                        "virtualIP": null,
                        "thumbprint": null,
                        "toUpdate": null,
                        "hostType": "Standard"
                    },
                    {
                        "name": "[concat(variables('botName'),'.scm.azurewebsites.net')]",
                        "sslState": "Disabled",
                        "virtualIP": null,
                        "thumbprint": null,
                        "toUpdate": null,
                        "hostType": "Repository"
                    }
                ],
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms/', 'stickerAzHostingPlan')]", 
                "reserved": false, 
                "siteConfig": {
                    "appSettings": [
                        {
                            "name":"MicrosoftAppId", 
                            "value":"[parameters('botAppId')]"
                        },
                        {
                            "name": "APPINSIGHTS_INSTRUMENTATIONKEY", 
                            "value": "[reference(resourceId('Microsoft.Insights/components', variables('stickerAppInsightsName')), '2015-05-01').InstrumentationKey]"
                        },
                        {
                            "name":"ConfigUri", 
                            "value":"[parameters('configUri')]"
                        }
                    ]
                }
            }, 
            "resources": [
                {
                    "apiVersion": "2015-08-01", 
                    "name":"web", 
                    "type": "sourcecontrols", 
                    "dependsOn": [
                        "[concat('Microsoft.Web/sites/', variables('stickersFunctionAppName'))]"
                    ], 
                    "properties": {
                        "RepoUrl": "[parameters('repoUrl')]", 
                        "branch": "[parameters('branchName')]", 
                        "isManualIntegration": true
                    }
                }
            ]
        },
        {
            "name":"[variables('stickerAppInsightsName')]", 
            "type":"Microsoft.Insights/components", 
            "kind": "other", 
            "apiVersion": "2015-05-01", 
            "location":"[resourceGroup().location]", 
            "tags": {}, 
            "scale": null, 
            "properties": {
                "Application_Type": "other"
            }, 
            "dependsOn": []
        }
    ],
    "outputs": {
        "outputMsgExtensionName": {
            "type":"string", 
            "value": "[variables('botName')]"
        }, 
        "outputMsAppId": {
            "type":"string", 
            "value":"[parameters('botAppId')]"
        }, 
        "outputMsgExtensionDescription": {
            "type":"string", 
            "value":"[parameters('botDescription')]"
        }
    }
}